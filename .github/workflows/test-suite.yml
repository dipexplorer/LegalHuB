name: Test Suite Runner

on:
    workflow_dispatch:
        inputs:
            test_suite:
                description: "Test suite to run"
                required: true
                default: "all"
                type: choice
                options:
                    - all
                    - appointment
                    - article
                    - chat
                    - dictionary
                    - document
                    - healthCheck
                    - lawyer
                    - review
                    - rights
                    - search
                    - user
            coverage:
                description: "Generate coverage reports"
                required: false
                default: false
                type: boolean
            node_version:
                description: "Node.js version"
                required: false
                default: "20"
                type: choice
                options:
                    - "18"
                    - "20"

jobs:
    test:
        name: Run Tests
        runs-on: ubuntu-latest

        steps:
            - name: ⬇️ Checkout Code
              uses: actions/checkout@v4

            - name: ⚙️ Setup Node.js ${{ github.event.inputs.node_version }}
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ github.event.inputs.node_version }}
                  cache: "npm"

            - name: 📦 Install Dependencies
              run: npm ci

            - name: 🧪 Run Test Suite
              run: |
                  if [ "${{ github.event.inputs.test_suite }}" = "all" ]; then
                    if [ "${{ github.event.inputs.coverage }}" = "true" ]; then
                      npm run test:coverage
                    else
                      npm test
                    fi
                  else
                    if [ "${{ github.event.inputs.coverage }}" = "true" ]; then
                      npm run test:suite -- --test=${{ github.event.inputs.test_suite }} --coverage
                    else
                      npm run test:suite -- --test=${{ github.event.inputs.test_suite }}
                    fi
                  fi

            - name: 📊 Upload Coverage Reports
              uses: codecov/codecov-action@v4
              if: github.event.inputs.coverage == 'true'
              with:
                  token: ${{ secrets.CODECOV_TOKEN }}
                  files: ./coverage/lcov.info
                  flags: unittests
                  name: codecov-umbrella
                  fail_ci_if_error: false
