<% layout("layouts/boilerplate") %>

<style>
:root {
    --primary: #9c27b0;
    --primary-hover: #7b1fa2;
    --primary-light: #e1bee7;
    --card-bg: rgba(255, 255, 255, 0.08);
    --input-bg: rgba(91, 89, 89, 0.12);
    --text: #f5f5f5;
    --subtext: #bbb;
    --error: #e74c3c;
    --success: #27ae60;
    --border: rgba(255, 255, 255, 0.2);
    --shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
}

/* Global Reset */
* {
    box-sizing: border-box;
}

/* Wrapper */
.form-wrapper {
    max-width: 900px;
    margin: 40px auto;
    padding: 40px;
    background: var(--card-bg);
    border-radius: 20px;
    box-shadow: var(--shadow);
    backdrop-filter: blur(10px);
    border: 1px solid var(--border);
}

/* Title */
.form-title {
    font-size: 2.5rem;
    font-weight: 700;
    color: #fff;
    margin-bottom: 40px;
    display: flex;
    align-items: center;
    gap: 15px;
    border-left: 6px solid var(--primary);
    padding-left: 20px;
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
}

/* Section Headings */
.section-heading {
    font-size: 1.4rem;
    font-weight: 600;
    color: var(--primary-light);
    margin-bottom: 15px;
    border-bottom: 2px solid var(--primary);
    padding-bottom: 8px;
    display: flex;
    align-items: center;
    gap: 10px;
}

/* Labels & Inputs */
.form-group {
    margin-bottom: 30px;
}

.form-group label {
    font-weight: 600;
    color: var(--text);
    display: block;
    margin-bottom: 10px;
    font-size: 1.1rem;
}

.form-group input {
    width: 100%;
    padding: 15px 18px;
    border: 2px solid transparent;
    border-radius: 12px;
    background: var(--input-bg);
    color: #fff;
    font-size: 1rem;
    outline: none;
    transition: all 0.3s ease;
    backdrop-filter: blur(5px);
}

.form-group input:focus {
    border-color: var(--primary);
    background: rgba(255, 255, 255, 0.18);
    box-shadow: 0 0 0 3px rgba(156, 39, 176, 0.2);
    transform: translateY(-1px);
}

.form-group input::placeholder {
    color: var(--subtext);
    opacity: 0.8;
}

/* Tags input */
#tags {
    color: var(--primary-light);
    font-weight: 500;
}

/* Section Block */
.section-wrapper {
    margin-bottom: 35px;
    padding: 25px;
    background: rgba(255, 255, 255, 0.08);
    border-radius: 16px;
    border-left: 5px solid var(--primary);
    border: 1px solid var(--border);
    backdrop-filter: blur(5px);
    transition: all 0.3s ease;
}

.section-wrapper:hover {
    background: rgba(255, 255, 255, 0.12);
    transform: translateY(-2px);
    box-shadow: 0 12px 24px rgba(0, 0, 0, 0.2);
}

.section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 18px;
}

.section-header h3 {
    font-size: 1.2rem;
    color: var(--primary-light);
    margin: 0;
    font-weight: 600;
}

.section-header .remove-section {
    background: var(--error);
    color: #fff;
    border: none;
    padding: 8px 16px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 0.9rem;
    font-weight: 500;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 5px;
}

.section-header .remove-section:hover {
    background: #c0392b;
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(231, 76, 60, 0.3);
}

/* Quill Editors */
.ql-toolbar.ql-snow {
    background: rgba(255, 255, 255, 0.12);
    border: 2px solid var(--border);
    border-radius: 12px 12px 0 0;
    display: flex;
    justify-content: center;
    flex-wrap: wrap;
    padding: 12px;
    backdrop-filter: blur(5px);
}

.ql-toolbar button {
    border-radius: 6px !important;
    margin: 2px !important;
    transition: all 0.2s ease !important;
}

.ql-toolbar button:hover {
    background: rgba(255, 255, 255, 0.2) !important;
    transform: translateY(-1px);
}

/* Make bold/italic buttons more visible */
.ql-toolbar button.ql-bold,
.ql-toolbar button.ql-italic {
    background: rgba(255, 255, 255, 0.9) !important;
    border-radius: 6px;
    margin: 2px;
}

.ql-toolbar button.ql-bold svg,
.ql-toolbar button.ql-italic svg {
    filter: invert(0) !important;
}

.ql-container.ql-snow {
    border: 2px solid var(--border);
    border-top: none;
    border-radius: 0 0 12px 12px;
    background: var(--input-bg);
    color: #fff;
    min-height: 220px;
    backdrop-filter: blur(5px);
}

.ql-editor {
    min-height: 180px;
    font-size: 1.05rem;
    color: #fff;
    line-height: 1.6;
    padding: 20px;
}

.ql-editor::before {
    color: var(--subtext) !important;
    opacity: 0.8;
}

.ql-toolbar svg {
    filter: brightness(2.2);
}

.ql-toolbar .ql-picker {
    color: #fff !important;
}

.ql-toolbar .ql-picker-options {
    background: rgba(51, 51, 51, 0.95);
    border: 1px solid var(--border);
    border-radius: 8px;
    backdrop-filter: blur(10px);
}

.ql-toolbar .ql-picker-item {
    color: #fff !important;
    padding: 8px 12px;
    transition: background 0.2s ease;
}

.ql-toolbar .ql-picker-item:hover {
    background: rgba(255, 255, 255, 0.1);
}

/* Add Section */
.add-section {
    margin: 30px 0 40px;
    background: var(--input-bg);
    color: var(--text);
    padding: 20px 24px;
    border-radius: 12px;
    cursor: pointer;
    font-size: 1.1rem;
    font-weight: 500;
    border: 2px dashed var(--border);
    transition: all 0.3s ease;
    text-align: center;
    backdrop-filter: blur(5px);
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
}

.add-section:hover {
    background: rgba(255, 255, 255, 0.18);
    border-color: var(--primary);
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(156, 39, 176, 0.2);
}

/* Action Buttons */
.form-actions {
    display: flex;
    justify-content: center;
    gap: 20px;
    margin-top: 50px;
    flex-wrap: wrap;
}

.btn {
    padding: 16px 32px;
    border: none;
    border-radius: 12px;
    font-size: 1.1rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    position: relative;
    overflow: hidden;
}

.btn::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
    transition: left 0.5s;
}

.btn:hover::before {
    left: 100%;
}

.btn-primary {
    background: linear-gradient(135deg, var(--primary), var(--primary-hover));
    color: white;
    box-shadow: 0 6px 20px rgba(156, 39, 176, 0.4);
}

.btn-primary:hover {
    background: linear-gradient(135deg, var(--primary-hover), var(--primary));
    transform: translateY(-3px);
    box-shadow: 0 8px 25px rgba(156, 39, 176, 0.5);
}

.btn-secondary {
    background: linear-gradient(135deg, #6c757d, #5a6268);
    color: #fff;
    box-shadow: 0 4px 12px rgba(108, 117, 125, 0.3);
}

.btn-secondary:hover {
    background: linear-gradient(135deg, #5a6268, #495057);
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(108, 117, 125, 0.4);
}

/* Loading Animation */
.loading {
    opacity: 0.7;
    pointer-events: none;
}

.loading .btn::after {
    content: '';
    position: absolute;
    width: 20px;
    height: 20px;
    margin: auto;
    border: 2px solid transparent;
    border-top-color: #ffffff;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* Form validation styles */
.form-group.error input,
.form-group.error textarea,
.form-group.error .ql-container {
    border-color: var(--error) !important;
    box-shadow: 0 0 0 3px rgba(231, 76, 60, 0.2) !important;
}

.error-message {
    color: var(--error);
    font-size: 0.9rem;
    margin-top: 8px;
    display: flex;
    align-items: center;
    gap: 6px;
    font-weight: 500;
}

.error-message::before {
    content: '‚ö†Ô∏è';
    font-size: 1rem;
}

/* Success state */
.form-group.success input,
.form-group.success textarea,
.form-group.success .ql-container {
    border-color: var(--success) !important;
    box-shadow: 0 0 0 3px rgba(39, 174, 96, 0.2) !important;
}

/* Responsive */
@media (max-width: 768px) {
    .form-wrapper {
        margin: 20px 15px;
        padding: 30px 25px;
    }

    .form-title {
        font-size: 2rem;
        margin-bottom: 30px;
    }

    .section-wrapper {
        padding: 20px 15px;
    }

    .section-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 12px;
    }

    .form-actions {
        flex-direction: column;
        align-items: stretch;
        gap: 15px;
    }

    .btn {
        width: 100%;
        justify-content: center;
    }
}

@media (max-width: 480px) {
    .form-wrapper {
        margin: 15px 10px;
        padding: 25px 20px;
    }

    .form-title {
        font-size: 1.8rem;
        flex-direction: column;
        text-align: center;
        gap: 10px;
        padding-left: 0;
        border-left: none;
        border-bottom: 4px solid var(--primary);
        padding-bottom: 15px;
    }

    .form-group input,
    .form-group textarea {
        padding: 14px 16px;
        font-size: 16px; /* Prevents zoom on iOS */
    }

    .ql-toolbar.ql-snow {
        padding: 8px;
    }

    .ql-editor {
        padding: 15px;
        min-height: 150px;
    }

    .section-wrapper {
        padding: 18px 15px;
    }
}
</style>

<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">

<div class="form-wrapper">
    <h1 class="form-title">
        <span>üìù</span>
        <span>Publish New Legal Article</span>
    </h1>

    <form action="/api/articles" method="POST" id="articleForm" novalidate>
        <!-- Title -->
        <div class="form-group">
            <label for="title">
                <span>üìÑ</span>
                Article Title
            </label>
            <input
                type="text"
                id="title"
                name="title"
                placeholder="Enter a compelling article title..."
                required
                maxlength="200"
                autocomplete="off"
            >
            <div class="error-message" id="title-error" style="display: none;"></div>
        </div>

        <!-- Tags -->
        <div class="form-group">
            <label for="tags">
                <span>üè∑Ô∏è</span>
                Tags (comma-separated)
            </label>
            <input
                type="text"
                id="tags"
                name="tags"
                placeholder="e.g., constitutional law, civil rights, legal precedent..."
                maxlength="500"
            >
            <div class="error-message" id="tags-error" style="display: none;"></div>
        </div>

        <!-- Introduction -->
        <div class="form-group">
            <h3 class="section-heading">
                <span>üìå</span>
                Introduction
            </h3>
            <div id="introductionEditor"></div>
            <textarea id="introduction" name="introduction" hidden></textarea>
            <div class="error-message" id="introduction-error" style="display: none;"></div>
        </div>

        <!-- Sections -->
        <div id="sections"></div>
        <div class="add-section" id="addSectionBtn">
            <span>‚ûï</span>
            <span>Add New Section</span>
        </div>

        <!-- Conclusion -->
        <div class="form-group">
            <h3 class="section-heading">
                <span>üîé</span>
                Conclusion
            </h3>
            <div id="conclusionEditor"></div>
            <textarea id="conclusion" name="conclusion" hidden></textarea>
            <div class="error-message" id="conclusion-error" style="display: none;"></div>
        </div>

        <!-- Buttons -->
        <div class="form-actions">
            <button type="submit" class="btn btn-primary" id="submitBtn">
                <span>‚úÖ</span>
                <span>Publish</span>
            </button>
            <a href="/articles" class="btn btn-secondary">
                <span>üîô</span>
                <span>Back</span>
            </a>
        </div>
    </form>
</div>

<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
<script>
// Enhanced toolbar options
const toolbarOptions = [
    ['bold', 'italic', 'underline', 'strike'],
    [{ 'list': 'ordered'}, { 'list': 'bullet' }],
    [{ 'indent': '-1'}, { 'indent': '+1' }],
    ['link', 'code-block'],
];

// Initialize editors with placeholders
const introductionEditor = new Quill('#introductionEditor', {
    theme: 'snow',
    modules: {
        toolbar: toolbarOptions
    },
    placeholder: 'Write a compelling introduction to your legal article...'
});

const conclusionEditor = new Quill('#conclusionEditor', {
    theme: 'snow',
    modules: {
        toolbar: toolbarOptions
    },
    placeholder: 'Summarize your key points and provide final thoughts...'
});

let sectionEditors = [];

// Form validation functions
function showError(fieldId, message) {
    const field = document.getElementById(fieldId);
    const errorDiv = document.getElementById(`${fieldId}-error`);

    if (field) {
        field.closest('.form-group').classList.add('error');
        field.closest('.form-group').classList.remove('success');
    }

    if (errorDiv) {
        errorDiv.textContent = message;
        errorDiv.style.display = 'flex';
    }
}

function showSuccess(fieldId) {
    const field = document.getElementById(fieldId);
    const errorDiv = document.getElementById(`${fieldId}-error`);

    if (field) {
        field.closest('.form-group').classList.remove('error');
        field.closest('.form-group').classList.add('success');
    }

    if (errorDiv) {
        errorDiv.style.display = 'none';
    }
}

// Real-time validation
document.getElementById('title').addEventListener('input', function() {
    const value = this.value.trim();
    if (value.length === 0) {
        showError('title', 'Article title is required');
    } else if (value.length < 10) {
        showError('title', 'Title should be at least 10 characters long');
    } else if (value.length > 200) {
        showError('title', 'Title should not exceed 200 characters');
    } else {
        showSuccess('title');
    }
});

// Add section functionality with improved UI
document.querySelector('.add-section').addEventListener('click', () => {
    const index = sectionEditors.length;
    const wrapper = document.createElement('div');
    wrapper.classList.add('section-wrapper');
    wrapper.style.opacity = '0';
    wrapper.style.transform = 'translateY(20px)';

    wrapper.innerHTML = `
        <div class="section-header">
            <h3>üìñ Section ${index + 1}</h3>
            <button type="button" class="remove-section">
                <span>üóëÔ∏è</span>
                <span>Remove</span>
            </button>
        </div>
        <div class="form-group">
            <label for="sectionTitle${index}">
                <span>üìù</span>
                Section Title
            </label>
            <input
                type="text"
                id="sectionTitle${index}"
                name="sectionTitles[]"
                placeholder="Enter section title..."
                required
                maxlength="150"
            >
            <div class="error-message" id="sectionTitle${index}-error" style="display: none;"></div>
        </div>
        <div class="form-group">
            <label for="sectionEditor${index}">
                <span>üìÑ</span>
                Section Content
            </label>
            <div id="sectionEditor${index}"></div>
            <textarea name="sectionContents[]" hidden></textarea>
            <div class="error-message" id="sectionEditor${index}-error" style="display: none;"></div>
        </div>
    `;

    document.getElementById('sections').appendChild(wrapper);

    // Animate in
    setTimeout(() => {
        wrapper.style.transition = 'all 0.3s ease';
        wrapper.style.opacity = '1';
        wrapper.style.transform = 'translateY(0)';
    }, 10);

    const quill = new Quill(`#sectionEditor${index}`, {
        theme: 'snow',
        modules: { toolbar: toolbarOptions },
        placeholder: 'Write the content for this section...'
    });

    sectionEditors.push({ quill, wrapper, index });

    // Add validation for section title
    document.getElementById(`sectionTitle${index}`).addEventListener('input', function() {
        const value = this.value.trim();
        if (value.length === 0) {
            showError(`sectionTitle${index}`, 'Section title is required');
        } else if (value.length < 5) {
            showError(`sectionTitle${index}`, 'Section title should be at least 5 characters long');
        } else {
            showSuccess(`sectionTitle${index}`);
        }
    });

    // Remove section functionality
    wrapper.querySelector('.remove-section').addEventListener('click', () => {
        wrapper.style.transition = 'all 0.3s ease';
        wrapper.style.opacity = '0';
        wrapper.style.transform = 'translateY(-20px)';

        setTimeout(() => {
            wrapper.remove();
            sectionEditors = sectionEditors.filter(s => s.wrapper !== wrapper);
            updateSectionNumbers();
        }, 300);
    });

    // Smooth scroll to new section
    setTimeout(() => {
        wrapper.scrollIntoView({
            behavior: 'smooth',
            block: 'center'
        });
    }, 100);
});

// Update section numbers after removal
function updateSectionNumbers() {
    sectionEditors.forEach((section, index) => {
        const header = section.wrapper.querySelector('.section-header h3');
        if (header) {
            header.textContent = `üìñ Section ${index + 1}`;
        }
    });
}

// Enhanced form submission with validation
document.getElementById('articleForm').addEventListener('submit', function(e) {
    e.preventDefault();

    let isValid = true;
    const submitBtn = document.getElementById('submitBtn');

    // Validate title
    const title = document.getElementById('title').value.trim();
    if (!title || title.length < 10) {
        showError('title', 'Please enter a valid title (at least 10 characters)');
        isValid = false;
    }

    // Validate introduction
    const introText = introductionEditor.getText().trim();
    if (!introText || introText.length < 50) {
        showError('introduction', 'Introduction should be at least 50 characters long');
        isValid = false;
    }

    // Validate conclusion
    const conclusionText = conclusionEditor.getText().trim();
    if (!conclusionText || conclusionText.length < 30) {
        showError('conclusion', 'Conclusion should be at least 30 characters long');
        isValid = false;
    }

    // Validate sections
    sectionEditors.forEach(({ quill, wrapper, index }) => {
        const titleInput = wrapper.querySelector(`#sectionTitle${index}`);
        const sectionTitle = titleInput.value.trim();
        const sectionText = quill.getText().trim();

        if (!sectionTitle || sectionTitle.length < 5) {
            showError(`sectionTitle${index}`, 'Section title is required (at least 5 characters)');
            isValid = false;
        }

        if (!sectionText || sectionText.length < 20) {
            showError(`sectionEditor${index}`, 'Section content should be at least 20 characters long');
            isValid = false;
        }
    });

    if (!isValid) {
        // Scroll to first error
        const firstError = document.querySelector('.form-group.error');
        if (firstError) {
            firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
        return;
    }

    // Show loading state
    submitBtn.disabled = true;
    submitBtn.classList.add('loading');
    submitBtn.innerHTML = '<span>‚è≥</span><span>Publishing...</span>';

    // Set editor values to hidden textareas
    document.getElementById('introduction').value = introductionEditor.root.innerHTML;
    document.getElementById('conclusion').value = conclusionEditor.root.innerHTML;

    sectionEditors.forEach(({ quill, wrapper }) => {
        const textarea = wrapper.querySelector('textarea');
        textarea.value = quill.root.innerHTML;
    });

    // Submit the form
    setTimeout(() => {
        this.submit();
    }, 500);
});

// Auto-save functionality (optional)
let autoSaveTimeout;
function autoSave() {
    clearTimeout(autoSaveTimeout);
    autoSaveTimeout = setTimeout(() => {
        const formData = {
            title: document.getElementById('title').value,
            tags: document.getElementById('tags').value,
            introduction: introductionEditor.root.innerHTML,
            conclusion: conclusionEditor.root.innerHTML,
            sections: sectionEditors.map(({ quill, wrapper, index }) => ({
                title: wrapper.querySelector(`#sectionTitle${index}`).value,
                content: quill.root.innerHTML
            }))
        };

        localStorage.setItem('article-draft', JSON.stringify(formData));
        console.log('Draft auto-saved');
    }, 2000);
}

// Trigger auto-save on content changes
document.getElementById('title').addEventListener('input', autoSave);
document.getElementById('tags').addEventListener('input', autoSave);
introductionEditor.on('text-change', autoSave);
conclusionEditor.on('text-change', autoSave);

// Load draft on page load
window.addEventListener('load', function() {
    const draft = localStorage.getItem('article-draft');
    if (draft && confirm('Would you like to restore your previous draft?')) {
        try {
            const data = JSON.parse(draft);
            document.getElementById('title').value = data.title || '';
            document.getElementById('tags').value = data.tags || '';

            if (data.introduction) {
                introductionEditor.root.innerHTML = data.introduction;
            }
            if (data.conclusion) {
                conclusionEditor.root.innerHTML = data.conclusion;
            }

            // Restore sections
            if (data.sections && data.sections.length > 0) {
                data.sections.forEach((section, index) => {
                    document.querySelector('.add-section').click();
                    setTimeout(() => {
                        const titleInput = document.querySelector(`#sectionTitle${index}`);
                        if (titleInput) titleInput.value = section.title || '';

                        const editor = sectionEditors[index];
                        if (editor && section.content) {
                            editor.quill.root.innerHTML = section.content;
                        }
                    }, 100);
                });
            }
        } catch (e) {
            console.error('Failed to restore draft:', e);
        }
    }
});

// Clear draft on successful submission
window.addEventListener('beforeunload', function() {
    localStorage.removeItem('article-draft');
});
</script>
